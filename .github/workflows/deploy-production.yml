name: ğŸš€ Deploy ProduÃ§Ã£o - Sistema NAPJe com IA

# PermissÃµes explÃ­citas para o token do workflow
permissions:
  contents: write
  actions: write
  pages: write
  id-token: write

on:
  push:
    branches: [ main, master ]
  # Removendo pull_request para evitar deploys em PRs de forks
  # pull_request:
  #   branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      enable_ai_features:
        description: 'Habilitar funcionalidades de IA'
        required: true
        default: true
        type: boolean

env:
  NODE_VERSION: '20'
  FORCE_COLOR: 1

jobs:
  # Job 0: VerificaÃ§Ãµes de SeguranÃ§a
  security-checks:
    name: ğŸ”’ VerificaÃ§Ãµes de SeguranÃ§a
    runs-on: ubuntu-latest
    outputs:
      is-safe-context: ${{ steps.check-context.outputs.is-safe }}
      
    steps:
      - name: ğŸ” Verificar contexto de execuÃ§Ã£o
        id: check-context
        run: |
          echo "ğŸ” Verificando contexto de seguranÃ§a..."
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          
          # Verificar se Ã© um contexto seguro
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master") ]]; then
            echo "âœ… Contexto seguro - push para branch principal"
            echo "is-safe=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "âœ… Contexto seguro - execuÃ§Ã£o manual"
            echo "is-safe=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Contexto nÃ£o seguro - pulando deploy sensÃ­vel"
            echo "is-safe=false" >> $GITHUB_OUTPUT
          fi

  # Job 1: VerificaÃ§Ãµes e Testes
  quality-checks:
    name: ğŸ” VerificaÃ§Ãµes de Qualidade
    runs-on: ubuntu-latest
    needs: security-checks
    if: needs.security-checks.outputs.is-safe-context == 'true'
    outputs:
      should-deploy: ${{ steps.check-changes.outputs.should-deploy }}
      
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Instalar dependÃªncias
        run: |
          npm ci --prefer-offline --no-audit
          
      - name: ğŸ§¹ Lint
        run: |
          echo "ğŸ” Executando ESLint para produÃ§Ã£o..."
                     npm run lint
          
      - name: ğŸ” Type Check
        run: |
          echo "ğŸ“ Verificando TypeScript..."
          npm run type-check
          
      - name: ğŸ”„ Verificar mudanÃ§as relevantes
        id: check-changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -E "\.(ts|tsx|js|jsx|json|md)$" > /dev/null; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… MudanÃ§as relevantes detectadas"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nenhuma mudanÃ§a relevante detectada"
          fi

  # Job 2: Build e Deploy das Edge Functions
  deploy-edge-functions:
    name: ğŸ¤– Deploy Edge Functions IA
    runs-on: ubuntu-latest
    needs: [security-checks, quality-checks]
    if: needs.security-checks.outputs.is-safe-context == 'true' && needs.quality-checks.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: ğŸš€ Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "ğŸ¤– Deployando Edge Functions de IA..."
          
          # Login no Supabase
          supabase login --token $SUPABASE_ACCESS_TOKEN
          
          # Link do projeto
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
          # Deploy das functions se existirem
          if [ -d "supabase/functions" ]; then
            echo "ğŸ“ Encontradas Edge Functions, deployando..."
            supabase functions deploy --no-verify-jwt
            echo "âœ… Edge Functions deployadas com sucesso!"
          else
            echo "â„¹ï¸ Nenhuma Edge Function encontrada para deploy"
          fi

  # Job 3: Build da AplicaÃ§Ã£o
  build:
    name: ğŸ—ï¸ Build AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [security-checks, quality-checks]
    if: needs.security-checks.outputs.is-safe-context == 'true' && needs.quality-checks.outputs.should-deploy == 'true'
    
    strategy:
      matrix:
        environment: [production]
        
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Instalar dependÃªncias
        run: |
          npm ci --prefer-offline --no-audit
          
      - name: ğŸŒ Configurar variÃ¡veis de ambiente
        run: |
          echo "ğŸ”§ Configurando ambiente de ${{ matrix.environment }}..."
          
          # Criar arquivo .env.production
          cat > .env.production << EOF
          NODE_ENV=production
          VITE_APP_ENV=${{ matrix.environment }}
          
          # Supabase Configuration
          VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
          
          # AI Features
          VITE_AI_FEATURES_ENABLED=${{ github.event.inputs.enable_ai_features || 'true' }}
          VITE_SMART_SEARCH_ENABLED=true
          VITE_AI_INSIGHTS_ENABLED=true
          VITE_SMART_NOTIFICATIONS_ENABLED=true
          VITE_SMART_FORMS_ENABLED=true
          
          # Performance & Analytics
          VITE_ENABLE_ANALYTICS=true
          VITE_ENABLE_PERFORMANCE_MONITORING=true
          
          # Build Info
          VITE_APP_TITLE=NAPJe - Painel de Atalhos Inteligente
          VITE_APP_VERSION=$(date +%Y%m%d%H%M%S)
          VITE_BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)
          VITE_COMMIT_HASH=${{ github.sha }}
          VITE_COMMIT_SHORT=${GITHUB_SHA::7}
          VITE_BRANCH_NAME=${GITHUB_REF#refs/heads/}
          EOF
          
          echo "âœ… VariÃ¡veis de ambiente configuradas"
          
      - name: ğŸ—ï¸ Build para produÃ§Ã£o
        run: |
          echo "ğŸ”¨ Iniciando build otimizado..."
          
          # Usar configuraÃ§Ã£o otimizada para produÃ§Ã£o
          npm run build:prod
          
          echo "âœ… Build concluÃ­do com sucesso!"

      - name: â™»ï¸ Preparar SPA 404 para GitHub Pages
        run: cp dist/index.html dist/404.html
          
      - name: ğŸ“Š AnÃ¡lise do Build
        run: |
          echo "ğŸ“Š Analisando build gerado..."
          
          # EstatÃ­sticas do build
          BUILD_SIZE=$(du -sh dist | cut -f1)
          FILE_COUNT=$(find dist -type f | wc -l)
          
          echo "ğŸ“ Tamanho do build: $BUILD_SIZE"
          echo "ğŸ“„ NÃºmero de arquivos: $FILE_COUNT"
          
          # Verificar arquivos grandes
          echo "ğŸ” Verificando arquivos grandes (>1MB):"
          find dist -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" -o -name "*.json" \) -exec gzip -9 -k {} \;
          
          # Criar arquivo de informaÃ§Ãµes do build
          cat > dist/build-info.json << EOF
          {
            "buildDate": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "commitHash": "${{ github.sha }}",
            "commitShort": "${GITHUB_SHA::7}",
            "branch": "${GITHUB_REF#refs/heads/}",
            "workflow": "${{ github.workflow }}",
            "runNumber": "${{ github.run_number }}",
            "actor": "${{ github.actor }}",
            "buildSize": "$BUILD_SIZE",
            "fileCount": $FILE_COUNT,
            "environment": "${{ matrix.environment }}",
            "aiFeatures": {
              "enabled": ${{ github.event.inputs.enable_ai_features || 'true' }},
              "smartSearch": true,
              "aiInsights": true,
              "smartNotifications": true,
              "smartForms": true
            }
          }
          EOF
          
      - name: ğŸ—œï¸ OtimizaÃ§Ãµes pÃ³s-build
        run: |
          echo "âš¡ Aplicando otimizaÃ§Ãµes..."
          
          # Comprimir arquivos estÃ¡ticos
          find dist -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" -o -name "*.json" \) -exec gzip -9 -k {} \;
          
          # Criar arquivo .nojekyll para GitHub Pages
          touch dist/.nojekyll
          
          # VerificaÃ§Ãµes finais
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html nÃ£o encontrado!"
            exit 1
          fi
          
          echo "âœ… OtimizaÃ§Ãµes aplicadas"
          
      - name: ğŸ“¤ Upload artifacts do build
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.environment }}-${{ github.sha }}
          path: dist/
          retention-days: 30

  # Job 4: Deploy para GitHub Pages
  deploy-github-pages:
    name: ğŸŒ Deploy GitHub Pages
    runs-on: ubuntu-latest
    needs: [security-checks, quality-checks, build]
    if: needs.security-checks.outputs.is-safe-context == 'true' && needs.quality-checks.outputs.should-deploy == 'true' && github.ref == 'refs/heads/main'
    
    # PermissÃµes jÃ¡ definidas globalmente, mas mantendo para clareza
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-production-${{ github.sha }}
          path: dist/
          
      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¤ Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/
          
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job 5: NotificaÃ§Ãµes e Cleanup
  post-deploy:
    name: ğŸ“¬ PÃ³s-deploy
    runs-on: ubuntu-latest
    needs: [deploy-github-pages, deploy-edge-functions]
    if: always()
    
    steps:
      - name: ğŸ‰ NotificaÃ§Ã£o de sucesso
        if: needs.deploy-github-pages.result == 'success'
        run: |
          echo "ğŸ‰ Deploy realizado com sucesso!"
          echo "ğŸ”— URL: https://msribeiro2010.github.io/napje-painel-atalhos/"
          echo "ğŸ¤– IA Features: Habilitadas"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          
      - name: âŒ NotificaÃ§Ã£o de falha
        if: needs.deploy-github-pages.result == 'failure' || needs.deploy-edge-functions.result == 'failure'
        run: |
          echo "âŒ Deploy falhou!"
          echo "ğŸ” Verifique os logs para mais detalhes"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"

  # Job 6: Limpeza de artifacts antigos
  cleanup:
    name: ğŸ§¹ Limpeza
    runs-on: ubuntu-latest
    needs: post-deploy
    if: always()
    
    steps:
      - name: ğŸ—‘ï¸ Limpar artifacts antigos
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const oldArtifacts = artifacts.data.artifacts
              .filter(artifact => artifact.name.startsWith('build-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(5); // Manter apenas os 5 mais recentes
              
            for (const artifact of oldArtifacts) {
              console.log(`ğŸ—‘ï¸ Removendo artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
            }
            
            console.log(`âœ… ${oldArtifacts.length} artifacts antigos removidos`);

# ConfiguraÃ§Ãµes de concorrÃªncia
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true